# Encoding: utf-8
require 'bundler/setup'

namespace :prepare do
  task :bundle do
    if ENV['CI']
      sh %(bundle install --path=.bundle --jobs 1 --retry 3 --verbose)
    else
      sh %(bundle install)
    end
  end

  task :berks do
    sh %(berks install)
  end
end

desc 'Install required Gems and Cookbooks'
task prepare: ['prepare:bundle', 'prepare:berks']

namespace :style do
  task :rubocop do
    sh %(rubocop)
  end

  task :foodcritic do
    sh %(foodcritic .)
  end
end

desc 'Run all style checks'
task style: ['style:foodcritic', 'style:rubocop']

namespace :integration do
  task :kitchen do
    sh %{kitchen test}
  end
end

task integration: ['integration:kitchen']

namespace :unit do
  task :chefspec do
    sh %(rspec test/unit/spec)
  end
end

desc 'Run all unit tests'
task unit: ['unit:chefspec']
task spec: ['unit']

# Run all tests
desc 'Run all tests'
task test: ['style', 'unit', 'integration']

# The default rake task should just run it all
desc 'Install required Gems and Cookbook then run all tests'
task default: ['prepare', 'test']

require "rubygems"
require "chef"
require "yard"
current_dir = File.dirname(__FILE__)
YARD::Config.load_plugin 'chef'
YARD::Rake::YardocTask.new do |t|
  t.files = ["#{current_dir}/**/*.rb"]
  #t.options = ['--debug']
end

require 'drud'
desc 'Generate the Readme.md file.'
task :readme do
  drud = Drud::Readme.new(current_dir)
  drud.render
end

desc "Setup direnv by updating path to have chefdk first and remove any rvm directories from the PATH"
task :direnv do
  File.open(".envrc", 'w') do |f|
    f.puts('eval "$(chef shell-init bash)"')
    f.puts('export PATH=./bin:$(IFS=:; t=($PATH); unset IFS; t=(${t[@]%%*rvm*}); IFS=:; echo "${t[*]}";)')
  end
end
